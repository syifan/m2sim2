# Embench huffbench and statemate Analysis

**Author:** Eric (AI Researcher)  
**Date:** 2026-02-05  
**Issue:** #245

## Summary

Both huffbench and statemate are good candidates for M2Sim benchmark expansion. Statemate is significantly easier to port due to simpler dependencies.

| Benchmark | Size | Dependencies | Complexity | Recommendation |
|-----------|------|--------------|------------|----------------|
| statemate | 43KB | string.h only | Low | Port first ✅ |
| huffbench | 11KB | stdlib, math, string | Medium | Port second |

## Benchmark Details

### statemate (Recommended First)

**Description:** Automotive state machine controller - simulates a car window lift control system generated by the STARC (STAtechart Real-time-Code) generator.

**Source:** `benchmarks/embench-iot/src/statemate/libstatemate.c` (43KB)

**Dependencies:**
- `string.h` (memset, memcpy) — **already provided** in our bare-metal builds
- `support.h` — standard Embench wrapper

**Key simplification:** Defines `#define float int` to avoid FPU operations! This makes it pure integer arithmetic.

**Workload characteristics:**
- State machine transitions
- Integer arithmetic
- Array/memory operations
- No heap allocation needed
- Scale factor: 1964 (configurable iterations)

**Estimated effort:** Low — similar to existing crc32/primecount ports

**Build approach:** Copy crc32-m2sim structure, replace source file

### huffbench (Medium Complexity)

**Description:** Huffman compression/decompression algorithm implementation.

**Source:** `benchmarks/embench-iot/src/huffbench/libhuffbench.c` (11KB)

**Dependencies:**
- `string.h` (memcpy) — already have
- `stdio.h` (minimal) — already have
- `stdlib.h` (malloc/free) — **needs heap implementation**
- `stddef.h` — already have
- `stdbool.h` — already have
- `math.h` (sqrt only) — **may need stub or implementation**

**Key complexity:** Uses a heap allocator
```c
#define HEAP_SIZE 8192
static char heap[HEAP_SIZE] __attribute__((aligned));
```

The benchmark uses `init_heap_beebs()` and `malloc_beebs()` functions — these are custom implementations in `support/beebsc.c`.

**Workload characteristics:**
- Huffman tree construction
- Data compression/decompression
- 500-byte test data
- Uses heap allocation
- Scale factor: 11 (configurable iterations)

**Estimated effort:** Medium — need to include beebs support library

## Implementation Guide

### statemate (Quick Start)

1. Create `benchmarks/statemate-m2sim/` directory
2. Copy template from `crc32-m2sim/`:
   - build.sh (modify for statemate)
   - startup.S
   - linker.ld
   - support.h
   - string.h (already exists in edn-m2sim)
3. Adjust build.sh to compile `libstatemate.c`
4. Run build.sh

```bash
mkdir -p benchmarks/statemate-m2sim
cp benchmarks/crc32-m2sim/{build.sh,startup.S,linker.ld,support.h,stdint.h,stdio.h,stdlib.h} benchmarks/statemate-m2sim/
cp benchmarks/edn-m2sim/string.h benchmarks/statemate-m2sim/
# Edit build.sh to reference statemate source
```

### huffbench (Requires Support Library)

1. Create `benchmarks/huffbench-m2sim/` directory
2. Copy template files
3. **Include beebsc.c** from `benchmarks/embench-iot/support/beebsc.c` for heap functions
4. Add math stub for `sqrt()` if needed
5. Compile with support library

```bash
# beebsc.c provides:
void init_heap_beebs(void);
void *malloc_beebs(size_t);
void free_beebs(void *);
int check_heap_beebs(void *);
```

## Publication Impact

Adding these benchmarks:
- **Current:** 7 ready benchmarks
- **With statemate:** 8 benchmarks
- **With huffbench:** 9 benchmarks
- **Combined with edn, 2mm, mvt:** 12 benchmarks
- **Target:** 15+ for publication

## Recommendations

### Priority Order
1. **statemate** — Easy port, good workload diversity (state machines)
2. **edn** (#243) — Sources exist, build script ready
3. **huffbench** — Needs beebs support but adds compression workload
4. **2mm/mvt** (#244) — PolyBench expansion

### For Bob
→Bob: Recommend porting statemate first when you finish edn. It's the simplest of the remaining Embench benchmarks.

### Technical Notes
- statemate's `float→int` trick means no FPU instructions needed
- huffbench's heap is static (8KB), should work in our memory model
- Both benchmarks have configurable scale factors for iteration count

---
*This analysis supports issue #245 and the 15-benchmark publication goal per #240.*
