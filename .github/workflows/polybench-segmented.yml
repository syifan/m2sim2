name: PolyBench Segmented Testing

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'benchmarks/polybench_test.go'
      - 'benchmarks/timing_harness.go'
      - 'timing/**'

jobs:
  polybench-group-1:
    name: PolyBench Group 1 (ATAX, BiCG, Jacobi1D)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify PolyBench ELFs exist
        run: |
          echo "Checking required ELF files for Group 1..."
          ls -la benchmarks/polybench/atax_m2sim.elf
          ls -la benchmarks/polybench/bicg_m2sim.elf
          ls -la benchmarks/polybench/jacobi-1d_m2sim.elf

      - name: Run Group 1 tests
        run: |
          echo "Running PolyBench Group 1: ATAX, BiCG, Jacobi1D"
          go test -v -run "TestPolybenchATAX|TestPolybenchBiCG|TestPolybenchJacobi1D" -count=1 -timeout 25m ./benchmarks/ 2>&1 | tee group1_output.txt

      - name: Upload Group 1 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polybench-group-1-results
          path: group1_output.txt
          retention-days: 7

  polybench-group-2:
    name: PolyBench Group 2 (MVT, GEMM)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify PolyBench ELFs exist
        run: |
          echo "Checking required ELF files for Group 2..."
          ls -la benchmarks/polybench/mvt_m2sim.elf
          ls -la benchmarks/polybench/gemm_m2sim.elf

      - name: Run Group 2 tests
        run: |
          echo "Running PolyBench Group 2: MVT, GEMM"
          go test -v -run "TestPolybenchMVT|TestPolybenchGEMM" -count=1 -timeout 25m ./benchmarks/ 2>&1 | tee group2_output.txt

      - name: Upload Group 2 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polybench-group-2-results
          path: group2_output.txt
          retention-days: 7

  polybench-group-3:
    name: PolyBench Group 3 (2MM, 3MM)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify PolyBench ELFs exist
        run: |
          echo "Checking required ELF files for Group 3..."
          ls -la benchmarks/polybench/2mm_m2sim.elf
          ls -la benchmarks/polybench/3mm_m2sim.elf

      - name: Run Group 3 tests
        run: |
          echo "Running PolyBench Group 3: 2MM, 3MM"
          go test -v -run "TestPolybench2MM|TestPolybench3MM" -count=1 -timeout 25m ./benchmarks/ 2>&1 | tee group3_output.txt

      - name: Upload Group 3 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polybench-group-3-results
          path: group3_output.txt
          retention-days: 7

  consolidate-results:
    name: Consolidate PolyBench Results
    runs-on: ubuntu-latest
    needs: [polybench-group-1, polybench-group-2, polybench-group-3]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all group results
        uses: actions/download-artifact@v4
        with:
          path: group-results

      - name: Consolidate and analyze results
        run: |
          echo "Consolidating results from all PolyBench groups..."

          # Combine all output files
          cat group-results/polybench-group-1-results/group1_output.txt > consolidated_polybench.txt || echo "Group 1 results missing"
          cat group-results/polybench-group-2-results/group2_output.txt >> consolidated_polybench.txt || echo "Group 2 results missing"
          cat group-results/polybench-group-3-results/group3_output.txt >> consolidated_polybench.txt || echo "Group 3 results missing"

          # Extract CPI data
          python3 - <<'PYEOF'
          import json
          import re
          import os

          results = {}
          try:
              with open("consolidated_polybench.txt") as f:
                  for line in f:
                      if "CPI=" not in line:
                          continue
                      match = re.search(r'(polybench_\w+):\s+cycles=(\d+),\s+insts=(\d+),\s+CPI=([\d.]+)', line)
                      if match:
                          name = match.group(1)
                          cycles = int(match.group(2))
                          insts = int(match.group(3))
                          cpi = float(match.group(4))
                          short_name = name.replace("polybench_", "")
                          if short_name == "jacobi1d":
                              short_name = "jacobi-1d"
                          results[short_name] = {
                              "sim_name": name,
                              "cycles": cycles,
                              "instructions": insts,
                              "cpi": cpi,
                          }
          except FileNotFoundError:
              print("WARNING: No consolidated results file found")

          output = {
              "source": "polybench_segmented_testing",
              "benchmarks_run": len(results),
              "results": results,
              "segmented_execution": True,
              "groups_completed": []
          }

          if os.path.exists("group-results/polybench-group-1-results/group1_output.txt"):
              output["groups_completed"].append("group-1")
          if os.path.exists("group-results/polybench-group-2-results/group2_output.txt"):
              output["groups_completed"].append("group-2")
          if os.path.exists("group-results/polybench-group-3-results/group3_output.txt"):
              output["groups_completed"].append("group-3")

          with open("polybench_segmented_results.json", "w") as f:
              json.dump(output, f, indent=2)

          print(json.dumps(output, indent=2))
          print(f"\nSegmented testing results: {len(results)} benchmarks from {len(output['groups_completed'])} groups")
          PYEOF

      - name: Upload consolidated results
        uses: actions/upload-artifact@v4
        with:
          name: polybench-segmented-consolidated
          path: |
            polybench_segmented_results.json
            consolidated_polybench.txt
          retention-days: 30

      - name: Post segmented testing summary
        if: always()
        run: |
          echo "## PolyBench Segmented Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f polybench_segmented_results.json ]; then
            python3 -c "
          import json
          d = json.load(open('polybench_segmented_results.json'))
          print(f'**Benchmarks measured:** {d[\"benchmarks_run\"]}/7 (from {len(d[\"groups_completed\"])} groups)')
          print(f'**Groups completed:** {\", \".join(d[\"groups_completed\"])}')
          print()
          if d['results']:
              print('| Benchmark | Cycles | Instructions | CPI |')
              print('|-----------|--------|--------------|-----|')
              for name, r in sorted(d['results'].items()):
                  print(f'| {name} | {r[\"cycles\"]} | {r[\"instructions\"]} | {r[\"cpi\"]:.3f} |')
          else:
              print('No benchmark results extracted.')
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "Segmented testing consolidation failed." >> $GITHUB_STEP_SUMMARY
          fi
