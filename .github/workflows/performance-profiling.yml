name: Performance Profiling Analysis

on:
  workflow_dispatch:
    inputs:
      bench_filter:
        description: 'Benchmark regex filter (e.g., "Pipeline", "Decoder", or ".")'
        required: false
        default: '.'
      benchtime:
        description: 'Iterations per benchmark (e.g., 1000x or 5s)'
        required: false
        default: '1000x'
      cpu_profile:
        description: 'Generate CPU profile (pprof)'
        type: boolean
        required: false
        default: true
      mem_profile:
        description: 'Generate memory profile (pprof)'
        type: boolean
        required: false
        default: true
  schedule:
    - cron: '0 2 * * 0'  # Sunday 2 AM UTC

jobs:
  profile-pipeline:
    name: Profile Pipeline Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Create output directory
        run: mkdir -p profiling-results

      - name: Run benchmarks with timing
        run: |
          FILTER="${{ github.event.inputs.bench_filter || '.' }}"
          BENCHTIME="${{ github.event.inputs.benchtime || '1000x' }}"

          go test -run='XXX_NO_MATCH' -bench="$FILTER" \
            -benchtime="$BENCHTIME" -count=5 \
            -benchmem \
            ./timing/pipeline/ | tee profiling-results/bench-output.txt

      - name: Generate CPU profile
        if: github.event.inputs.cpu_profile != 'false'
        run: |
          # Run a representative benchmark for CPU profiling
          go test -run='XXX_NO_MATCH' -bench=BenchmarkPipelineTick8Wide \
            -benchtime=5s -count=1 \
            -cpuprofile=profiling-results/cpu.prof \
            ./timing/pipeline/

          # Generate text report from CPU profile
          go tool pprof -text profiling-results/cpu.prof > profiling-results/cpu-profile-text.txt 2>&1 || true
          go tool pprof -top profiling-results/cpu.prof > profiling-results/cpu-top.txt 2>&1 || true

      - name: Generate memory profile
        if: github.event.inputs.mem_profile != 'false'
        run: |
          go test -run='XXX_NO_MATCH' -bench=BenchmarkPipelineTick8Wide \
            -benchtime=5s -count=1 \
            -memprofile=profiling-results/mem.prof \
            ./timing/pipeline/

          go tool pprof -text -alloc_space profiling-results/mem.prof > profiling-results/mem-alloc-text.txt 2>&1 || true
          go tool pprof -top -alloc_space profiling-results/mem.prof > profiling-results/mem-alloc-top.txt 2>&1 || true

      - name: Generate summary report
        if: always()
        run: |
          cat > profiling-results/SUMMARY.md << 'HEADER'
          # Performance Profiling Results
          HEADER

          echo "**Date:** $(date -u)" >> profiling-results/SUMMARY.md
          echo "**Commit:** ${{ github.sha }}" >> profiling-results/SUMMARY.md
          echo "" >> profiling-results/SUMMARY.md

          echo "## Benchmark Results" >> profiling-results/SUMMARY.md
          echo '```' >> profiling-results/SUMMARY.md
          cat profiling-results/bench-output.txt >> profiling-results/SUMMARY.md
          echo '```' >> profiling-results/SUMMARY.md
          echo "" >> profiling-results/SUMMARY.md

          if [ -f profiling-results/cpu-top.txt ]; then
            echo "## CPU Profile (Top Functions)" >> profiling-results/SUMMARY.md
            echo '```' >> profiling-results/SUMMARY.md
            head -30 profiling-results/cpu-top.txt >> profiling-results/SUMMARY.md
            echo '```' >> profiling-results/SUMMARY.md
            echo "" >> profiling-results/SUMMARY.md
          fi

          if [ -f profiling-results/mem-alloc-top.txt ]; then
            echo "## Memory Allocation Profile (Top)" >> profiling-results/SUMMARY.md
            echo '```' >> profiling-results/SUMMARY.md
            head -30 profiling-results/mem-alloc-top.txt >> profiling-results/SUMMARY.md
            echo '```' >> profiling-results/SUMMARY.md
          fi

      - name: Upload profiling results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-profiling-results
          path: profiling-results/
          retention-days: 30

      - name: Display summary
        if: always()
        run: |
          if [ -f profiling-results/SUMMARY.md ]; then
            cat profiling-results/SUMMARY.md >> "$GITHUB_STEP_SUMMARY"
          fi

  profile-cmd:
    name: Profile via cmd/profile tool
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build profile tool
        run: go build -o profile-tool ./cmd/profile

      - name: Create output directory
        run: mkdir -p cmd-profiling-results

      - name: Profile emulation mode
        run: |
          # Use a microbenchmark ELF if available, otherwise skip
          ELF=$(find benchmarks -name '*.elf' -type f | head -1)
          if [ -z "$ELF" ]; then
            echo "No ELF binaries found, skipping cmd/profile tests"
            exit 0
          fi

          echo "Profiling: $ELF"
          ./profile-tool \
            -cpuprofile=cmd-profiling-results/emu-cpu.prof \
            -memprofile=cmd-profiling-results/emu-mem.prof \
            -duration=10s \
            "$ELF" > cmd-profiling-results/emu-output.txt 2>&1 || true

      - name: Profile timing mode
        run: |
          ELF=$(find benchmarks -name '*.elf' -type f | head -1)
          if [ -z "$ELF" ]; then
            exit 0
          fi

          ./profile-tool -timing \
            -cpuprofile=cmd-profiling-results/timing-cpu.prof \
            -memprofile=cmd-profiling-results/timing-mem.prof \
            -duration=10s \
            "$ELF" > cmd-profiling-results/timing-output.txt 2>&1 || true

      - name: Profile fast-timing mode
        run: |
          ELF=$(find benchmarks -name '*.elf' -type f | head -1)
          if [ -z "$ELF" ]; then
            exit 0
          fi

          ./profile-tool -fast-timing \
            -cpuprofile=cmd-profiling-results/fast-timing-cpu.prof \
            -memprofile=cmd-profiling-results/fast-timing-mem.prof \
            -duration=10s \
            "$ELF" > cmd-profiling-results/fast-timing-output.txt 2>&1 || true

      - name: Generate mode comparison
        if: always()
        run: |
          echo "# cmd/profile Mode Comparison" > cmd-profiling-results/SUMMARY.md
          echo "" >> cmd-profiling-results/SUMMARY.md

          for mode in emu timing fast-timing; do
            outfile="cmd-profiling-results/${mode}-output.txt"
            if [ -f "$outfile" ]; then
              echo "## ${mode}" >> cmd-profiling-results/SUMMARY.md
              echo '```' >> cmd-profiling-results/SUMMARY.md
              cat "$outfile" >> cmd-profiling-results/SUMMARY.md
              echo '```' >> cmd-profiling-results/SUMMARY.md
              echo "" >> cmd-profiling-results/SUMMARY.md
            fi
          done

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmd-profiling-results
          path: cmd-profiling-results/
          retention-days: 30

      - name: Display summary
        if: always()
        run: |
          if [ -f cmd-profiling-results/SUMMARY.md ]; then
            cat cmd-profiling-results/SUMMARY.md >> "$GITHUB_STEP_SUMMARY"
          fi
